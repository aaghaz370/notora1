<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>EduSpark — Smart Pomodoro Timer Widget</title>

<!-- Google font & icons -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
  :root{
    --bg: #0d1117;
    --card: rgba(18,20,26,0.85);
    --muted: #9aa4b2;
    --accent: #7c4dff;
    --accent-2: #ff6b6b;
    --glass: rgba(255,255,255,0.03);
    --glass-2: rgba(255,255,255,0.02);
    --radius: 14px;
    --smooth: 300ms cubic-bezier(.2,.9,.2,1);
    --shadow: 0 8px 30px rgba(2,6,23,0.6);
  }
  
  /* Mobile-first reset */
  html,body{
    height:100%;
    margin:0;
    font-family:Inter,system-ui,Arial;
    color:#e6eef8;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));

    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    overflow-x:hidden; 
    touch-action: manipulation; 
  }
  
  /* Mobile UI improvement: floating clock button - optimized for touch */
  .floating-clock{
    position:fixed;
    right:16px; /* Mobile UI improvement: closer to edge for easier thumb reach */
    bottom:20px;
    width:64px; /* Mobile UI improvement: larger touch target */
    height:64px;
    border-radius:50%;
    display:flex;
    align-items:center;
    justify-content:center;
    background:linear-gradient(135deg,var(--accent),var(--accent-2));
    color:white;
    box-shadow: 0 10px 30px rgba(124,77,255,0.18);
    cursor:grab;
    z-index:99999;
    transition: transform var(--smooth), box-shadow var(--smooth);
    user-select:none;
    -webkit-tap-highlight-color: transparent; /* Mobile UI improvement: remove tap highlight */
  }
  .floating-clock:active{
    cursor:grabbing; 
    transform:scale(.95); /* Mobile UI improvement: better touch feedback */
  }
  .floating-clock .time-mini{
    font-weight:700;
    font-size:12px;
    letter-spacing:0.5px;
  }
  .floating-clock .pulse{
    position:absolute;
    width:100%;
    height:100%;
    border-radius:50%;
    left:0;top:0;
    background:radial-gradient(circle at 30% 30%, rgba(255,255,255,0.08), transparent 30%);
    animation: floatPulse 2.8s ease-in-out infinite;
    z-index:-1;
    transform-origin:center;
  }
  @keyframes floatPulse{
    0%{transform:scale(.95);opacity:.95}
    50%{transform:scale(1.07);opacity:.7}
    100%{transform:scale(.95);opacity:.95}
  }
  
  /* Mobile UI improvement: modal overlay with mobile optimizations */
  .ts-overlay{
    position:fixed;
    inset:0;
    background:rgba(2,6,12,0.75); /* Mobile UI improvement: darker overlay for better contrast */
    display:none;
    align-items:flex-start; /* Mobile UI improvement: align to top for easier scrolling */
    justify-content:center;
    z-index:99990;
    padding:0; /* Mobile UI improvement: remove padding for full-screen modal */
    backdrop-filter: blur(8px); /* Mobile UI improvement: stronger blur */
    overflow-y:auto;
    -webkit-overflow-scrolling: touch; /* Mobile UI improvement: smooth iOS scrolling */
  }
  .ts-overlay.show{display:flex}
  
  /* Mobile UI improvement: modal redesigned for mobile-first */
  .ts-modal{
    width:100%;
    max-width:100vw;
    min-height:100vh; /* Mobile UI improvement: full-height on mobile */
    border-radius:0; /* Mobile UI improvement: no radius on mobile */
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    box-shadow:none; /* Mobile UI improvement: remove shadow on mobile */
    overflow:hidden;
    display:flex;
    flex-direction:column; /* Mobile UI improvement: stack panels vertically */
    transition:transform var(--smooth),opacity var(--smooth);
    transform-origin:center;
  }
  
  /* Mobile UI improvement: tablet/desktop breakpoint */
  @media(min-width:768px){ 
    .ts-overlay{
      align-items:center;
      padding:28px;
    }
    .ts-modal{
      width:920px;
      max-width:calc(100% - 48px);
      min-height:auto;
      border-radius:18px;
      display:grid;
      grid-template-columns: 1fr 420px;
      box-shadow:var(--shadow);
    }
  }
   /* --- TIMER ISOLATION FIX --- */
/* .ts-overlay {
  display: none !important;
  opacity: 0;
  pointer-events: none;
  visibility: hidden;
  transition: opacity 0.3s ease, visibility 0.3s ease;
}

.ts-overlay.show {
  display: flex !important;
  opacity: 1;
  pointer-events: all;
  visibility: visible;
}

.ts-modal {
  z-index: 99999;
  
  background: rgba(18, 20, 26, 0.95); /* solid dark for clarity */

  /* backdrop-filter: blur(20px); */

  
  
  /* Mobile UI improvement: left panel optimized for mobile */
  .panel-left{
    padding:20px 16px 24px 16px; /* Mobile UI improvement: tighter padding */
    border-right:none; /* Mobile UI improvement: remove border on mobile */
    border-bottom:1px solid rgba(255,255,255,0.03); /* Mobile UI improvement: bottom border instead */
    min-height:auto;
    position:relative;
  }
  
  @media(min-width:768px){
    .panel-left{
      padding:28px 28px 32px 28px;
      border-right:1px solid rgba(255,255,255,0.03);
      border-bottom:none;
      min-height:420px;
    }
  }
  
  .panel-right{
    padding:20px 16px; /* Mobile UI improvement: tighter padding */
    background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));
  }
  
  @media(min-width:768px){
    .panel-right{
      padding:28px;
    }
  }

  /* Mobile UI improvement: header with close button */
  .modal-head{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px; /* Mobile UI improvement: tighter gap */
    margin-bottom:16px; /* Mobile UI improvement: reduced margin */
  }
  .modal-head .title{
    display:flex;
    gap:10px; /* Mobile UI improvement: tighter gap */
    align-items:center;
    flex:1;
  }
  .brand-badge{
    width:40px; /* Mobile UI improvement: slightly smaller */
    height:40px;
    border-radius:10px;
    background:linear-gradient(135deg,var(--accent),var(--accent-2));
    display:flex;
    align-items:center;
    justify-content:center;
    color:#fff;
    font-weight:700;
    font-size:16px; /* Mobile UI improvement: adjusted font size */
    box-shadow:0 8px 24px rgba(124,77,255,0.16);
  }
  .modal-head .title h3{
    margin:0;
    font-size:1rem; /* Mobile UI improvement: smaller heading */
  }
  .modal-head .small-muted{
    color:var(--muted);
    font-size:12px; /* Mobile UI improvement: smaller text */
    display:none; /* Mobile UI improvement: hide on smallest screens */
  }
  
  @media(min-width:480px){
    .modal-head .small-muted{display:block;}
    .modal-head .title h3{font-size:1.1rem;}
    .brand-badge{width:44px;height:44px;font-size:18px;}
  }

  /* Mobile UI improvement: close button for mobile */
  .close-modal-btn{
    width:36px;
    height:36px;
    border-radius:8px;
    background:rgba(255,255,255,0.05);
    border:none;
    color:#fff;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    transition:all var(--smooth);
    -webkit-tap-highlight-color: transparent;
  }
  .close-modal-btn:active{
    transform:scale(.9);
    background:rgba(255,255,255,0.08);
  }

  /* Mobile UI improvement: timer display optimized */
  .timer-big{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:10px; /* Mobile UI improvement: tighter spacing */
    padding:12px 6px; /* Mobile UI improvement: reduced padding */
  }
  .timer-display{
    font-size:48px; /* Mobile UI improvement: slightly smaller for mobile */
    font-weight:800;
    color:#e9e9ff;
    letter-spacing:1px;
    text-shadow: 0 12px 40px rgba(124,77,255,0.08);
  }
  
  @media(min-width:480px){
    .timer-display{font-size:56px;}
    .timer-big{gap:12px;padding:18px 6px;}
  }
  
  /* Mobile UI improvement: controls optimized for touch */
  .timer-controls{
    display:flex;
    gap:8px; /* Mobile UI improvement: tighter gap */
    margin-top:6px;
    flex-wrap:wrap;
    justify-content:center;
  }
  .btn{
    border:none;
    padding:10px 14px; /* Mobile UI improvement: adjusted padding */
    border-radius:10px;
    font-weight:700;
    font-size:14px; /* Mobile UI improvement: slightly smaller */
    cursor:pointer;
    display:inline-flex;
    gap:8px;
    align-items:center;
    transition:transform var(--smooth),box-shadow var(--smooth);
    -webkit-tap-highlight-color: transparent;
    min-height:44px; /* Mobile UI improvement: minimum touch target */
  }
  .btn:active{transform:scale(.96);} /* Mobile UI improvement: better touch feedback */
  .btn-start{
    background:linear-gradient(90deg,#2bd48d,#18b26a);
    color:#052811; 
    box-shadow:0 14px 30px rgba(45,209,141,0.12);
  }
  .btn-pause{
    background:transparent;
    border:1px solid rgba(255,255,255,0.07);
    color:#dfe7f6;
  }
  .btn-reset{
    background:transparent;
    border:1px dashed rgba(255,255,255,0.04);
    color:var(--muted);
  }
  
  @media(min-width:480px){
    .btn{padding:12px 18px;font-size:15px;}
    .timer-controls{gap:12px;}
  }
  
  .control-small{font-size:12px;color:var(--muted);}

  /* Mobile UI improvement: presets with better touch targets */
  .presets{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    margin-top:12px;
    justify-content:center;
  }
  .preset-item{
    background:var(--glass-2);
    padding:10px 14px; /* Mobile UI improvement: larger touch area */
    min-width:50px; /* Mobile UI improvement: minimum width */
    border-radius:10px;
    color:#dbe8ff;
    font-weight:600;
    font-size:14px;
    cursor:pointer;
    transition:all .22s;
    text-align:center;
    -webkit-tap-highlight-color: transparent;
  }
  .preset-item:active{
    transform:scale(.94); /* Mobile UI improvement: touch feedback */
    box-shadow:0 10px 28px rgba(124,77,255,0.08);
  }
  
  @media(min-width:480px){
    .preset-item:hover{
      transform:translateY(-6px);
      box-shadow:0 10px 28px rgba(124,77,255,0.08);
    }
  }

  /* Mobile UI improvement: stat cards responsive */
  .stats-row{
    display:grid;
    grid-template-columns:repeat(3,1fr); /* Mobile UI improvement: always 3 columns */
    gap:8px; /* Mobile UI improvement: tighter gap */
    margin-top:16px;
  }
  .stat-card{
    background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));
    padding:10px 8px; /* Mobile UI improvement: tighter padding */
    border-radius:10px;
    text-align:center;
  }
  .stat-card .num{
    font-weight:800;
    font-size:18px; /* Mobile UI improvement: smaller on mobile */
    color:#fff;
  }
  .stat-card .label{
    font-size:11px; /* Mobile UI improvement: smaller label */
    color:var(--muted);
    margin-top:4px;
  }
  
  @media(min-width:480px){
    .stats-row{gap:12px;margin-top:18px;}
    .stat-card{padding:12px;}
    .stat-card .num{font-size:22px;}
    .stat-card .label{font-size:13px;margin-top:6px;}
  }

  /* Progress bar */
  .progress-wrap{margin-top:16px;}
  .progress-bar{
    height:8px; /* Mobile UI improvement: slightly thinner */
    background:rgba(255,255,255,0.04);
    border-radius:6px;
    overflow:hidden;
  }
  .progress-bar > div{
    height:100%;
    background:linear-gradient(90deg,var(--accent),var(--accent-2));
    width:0%;
    transition:width 600ms ease;
  }
  
  @media(min-width:480px){
    .progress-wrap{margin-top:18px;}
    .progress-bar{height:10px;}
  }

  /* Mobile UI improvement: right panel optimized */
  .panel-right h4{
    margin:0 0 10px 0; /* Mobile UI improvement: tighter margin */
    color:#dfe8ff;
    font-size:15px; /* Mobile UI improvement: smaller heading */
  }
  
  @media(min-width:480px){
    .panel-right h4{margin:0 0 12px 0;font-size:16px;}
  }
  
  .graph-wrap{
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:12px;
    padding:12px; /* Mobile UI improvement: tighter padding */
  }
  
  @media(min-width:480px){
    .graph-wrap{padding:14px;}
  }
  
  canvas{
    width:100%!important;
    height:200px!important; /* Mobile UI improvement: shorter on mobile */
    display:block;
  }
  
  @media(min-width:480px){
    canvas{height:240px!important;}
  }

  .history{
    margin-top:12px;
    max-height:160px; /* Mobile UI improvement: shorter on mobile */
    overflow:auto;
    padding-right:6px;
    -webkit-overflow-scrolling: touch; /* Mobile UI improvement: smooth iOS scrolling */
  }
  
  @media(min-width:480px){
    .history{max-height:180px;margin-top:14px;}
  }
  
  .session-item{
    display:flex;
    justify-content:space-between;
    padding:8px;
    border-radius:8px;
    margin-bottom:6px; /* Mobile UI improvement: tighter spacing */
    background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);
    font-size:12px; /* Mobile UI improvement: smaller text */
  }
  .session-item .left{color:#dbe8ff;}
  .session-item .right{
    color:var(--muted);
    white-space:nowrap; /* Mobile UI improvement: prevent wrapping */
  }
  
  @media(min-width:480px){
    .session-item{padding:8px 10px;margin-bottom:8px;font-size:13px;}
  }

  /* Mobile UI improvement: modal footer responsive */
  .modal-foot{
    display:flex;
    flex-direction:column; /* Mobile UI improvement: stack on mobile */
    gap:12px;
    margin-top:16px;
    color:var(--muted);
    font-size:12px;
  }
  
  @media(min-width:480px){
    .modal-foot{
      flex-direction:row;
      justify-content:space-between;
      align-items:center;
      margin-top:18px;
      font-size:13px;
    }
  }
  
  .goal-input{
    width:70px; /* Mobile UI improvement: narrower */
    padding:8px;
    border-radius:8px;
    border:1px solid rgba(255,255,255,0.05); /* Mobile UI improvement: subtle border */
    background:rgba(255,255,255,0.02);
    color:#fff;
    text-align:center;
    font-size:14px;
  }
  
  @media(min-width:480px){
    .goal-input{width:80px;}
  }

  /* Mobile UI improvement: view toggle chips */
  .view-toggle{
    display:flex;
    gap:6px;
    align-items:center;
  }
  .chip{
    padding:7px 10px; /* Mobile UI improvement: adjusted padding */
    border-radius:999px;
    background:transparent;
    border:1px solid rgba(255,255,255,0.03);
    color:var(--muted);
    cursor:pointer;
    font-size:12px; /* Mobile UI improvement: smaller text */
    display:inline-flex;
    align-items:center;
    gap:4px;
    transition:all var(--smooth);
    -webkit-tap-highlight-color: transparent;
    white-space:nowrap;
  }
  .chip i{font-size:11px;} /* Mobile UI improvement: smaller icons */
  .chip.active{
    background:linear-gradient(90deg,var(--accent),var(--accent-2));
    color:#fff;
    border:none;
    box-shadow:0 12px 30px rgba(124,77,255,0.12);
  }
  
  @media(min-width:480px){
    .chip{padding:8px 10px;font-size:13px;}
    .chip i{font-size:12px;}
    .view-toggle{gap:8px;}
  }

  /* Mobile UI improvement: toast notification system */
  .toast-container{
    position:fixed;
    top:20px;
    left:50%;
    transform:translateX(-50%);
    z-index:100000;
    display:flex;
    flex-direction:column;
    gap:10px;
    pointer-events:none;
    width:calc(100% - 32px);
    max-width:400px;
  }
  .toast{
    background:linear-gradient(135deg, rgba(124,77,255,0.95), rgba(255,107,107,0.95));
    color:#fff;
    padding:12px 16px;
    border-radius:12px;
    box-shadow:0 8px 24px rgba(0,0,0,0.3);
    display:flex;
    align-items:center;
    gap:10px;
    font-size:14px;
    font-weight:600;
    animation:toastSlideIn 0.3s ease;
    pointer-events:auto;
  }
  .toast.success{
    background:linear-gradient(135deg, rgba(43,212,141,0.95), rgba(24,178,106,0.95));
  }
  .toast.warning{
    background:linear-gradient(135deg, rgba(255,193,7,0.95), rgba(255,152,0,0.95));
  }
  @keyframes toastSlideIn{
    from{opacity:0;transform:translateY(-20px);}
    to{opacity:1;transform:translateY(0);}
  }

  /* Micro animations */
  .fade-in{animation:animFade .45s ease both}
  @keyframes animFade{
    from{opacity:0;transform:translateY(6px)}
    to{opacity:1;transform:translateY(0)}
  }
  
  /* Mobile UI improvement: smooth scroll behavior */
  html{scroll-behavior:smooth;}
  
  /* Mobile UI improvement: custom scrollbar */
  .history::-webkit-scrollbar{width:4px;}
  .history::-webkit-scrollbar-track{background:rgba(255,255,255,0.02);}
  .history::-webkit-scrollbar-thumb{
    background:rgba(124,77,255,0.3);
    border-radius:4px;
  }
</style>
</head>
<body>

<!-- Mobile UI improvement: toast container for notifications -->
<div class="toast-container" id="toastContainer"></div>

<!-- Floating draggable clock -->
<div class="floating-clock" id="floatingClock" title="Open Study Timer">
  <div class="pulse"></div>
  <div class="time-mini" id="miniTime">25:00</div>
</div>

<!-- Modal -->
<div class="ts-overlay" id="overlay" aria-hidden="true">
  <div class="ts-modal" role="dialog" aria-modal="true" aria-label="Study Timer Modal">
    <!-- left: timer view & stats -->
    <div class="panel-left">
      <div class="modal-head">
        <div class="title">
          <div class="brand-badge">ES</div>
          <div>
            <h3>Study Timer</h3>
            <div class="small-muted">Pomodoro • Focus Sessions</div>
          </div>
        </div>

        <div style="display:flex;gap:8px;align-items:center;">
          <div class="view-toggle">
            <div class="chip active" id="viewTimerBtn"><i class="fa-solid fa-stopwatch"></i><span style="display:none;" class="chip-text">Timer</span></div>
            <div class="chip" id="viewGraphBtn"><i class="fa-solid fa-chart-column"></i><span style="display:none;" class="chip-text">Graph</span></div>
          </div>
          <!-- Mobile UI improvement: close button -->
          <button class="close-modal-btn" id="closeModalBtn" aria-label="Close modal">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
      </div>

      <!-- Timer block -->
      <div id="timerBlock" class="fade-in">
        <div class="timer-big">
          <div class="timer-display" id="timerDisplay">25:00</div>

          <div style="display:flex;gap:12px;align-items:center;">
            <div class="timer-controls">
              <button class="btn btn-start" id="startBtn"><i class="fa-solid fa-play"></i> Start</button>
              <button class="btn btn-pause" id="pauseBtn"><i class="fa-solid fa-pause"></i> Pause</button>
              <button class="btn btn-reset" id="resetBtn"><i class="fa-solid fa-rotate"></i> Reset</button>
            </div>
          </div>

          <div class="presets" aria-label="Quick time presets">
            <div class="preset-item" data-min="15">15m</div>
            <div class="preset-item" data-min="25">25m</div>
            <div class="preset-item" data-min="30">30m</div>
            <div class="preset-item" data-min="45">45m</div>
            <div class="preset-item" data-min="60">60m</div>
          </div>

          <div class="stats-row">
            <div class="stat-card">
              <div class="num" id="statSessions">0</div>
              <div class="label">Sessions</div>
            </div>
            <div class="stat-card">
              <div class="num" id="statThisWeek">0h</div>
              <div class="label">This Week</div>
            </div>
            <div class="stat-card">
              <div class="num" id="statGoalPerc">0%</div>
              <div class="label">Goal</div>
            </div>
          </div>

          <div class="progress-wrap">
            <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--muted);margin-top:12px">
              <div>Today's Progress</div>
              <div id="progressLabel">0/60 min</div>
            </div>
            <div class="progress-bar" aria-label="Daily progress bar" style="margin-top:8px">
              <div id="progressFill" style="width:0%"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Graph block hidden by default -->
      <div id="graphBlock" style="display:none">
        <div style="padding:8px 4px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:700;color:#e9f0ff;font-size:14px;">Focus & Progress</div>
            <div class="control-small">View: <span id="graphRange">Week</span></div>
          </div>

          <div style="display:flex;gap:8px;margin-top:10px">
            <div class="chip active" id="weekRange">Week</div>
            <div class="chip" id="monthRange">Month</div>
          </div>

          <div class="graph-wrap" style="margin-top:12px">
            <canvas id="focusChart" width="600" height="240"></canvas>
          </div>

          <div class="history" id="historyList"></div>
        </div>
      </div>

      <div class="modal-foot">
        <div>
          <div style="font-weight:700">Daily Goal (min)</div>
          <div style="margin-top:8px"><input class="goal-input" id="dailyGoal" type="number" min="10" value="60"></div>
        </div>
        <div>
          <div class="control-small">Notifications</div>
          <div style="margin-top:6px"><label style="display:inline-flex;align-items:center;gap:8px"><input type="checkbox" id="notifyToggle"> Enable</label></div>
        </div>
      </div>
    </div>

    <!-- right: history, session list & settings -->
    <div class="panel-right">
      <h4>Session History</h4>
      <div style="color:var(--muted);font-size:12px">All tracked sessions are stored locally on your device. Weekly data auto-rotates every 7 days.</div>

      <div style="margin-top:12px" id="rightStats">
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:12px">
          <div>
            <div style="font-size:11px;color:var(--muted)">Weekly Total</div>
            <div style="font-weight:800;font-size:16px" id="rightWeekTotal">0 min</div>
          </div>
          <div>
            <div style="font-size:11px;color:var(--muted)">Monthly Total</div>
            <div style="font-weight:800;font-size:16px" id="rightMonthTotal">0 min</div>
          </div>
          <div>
            <div style="font-size:11px;color:var(--muted)">Sessions</div>
            <div style="font-weight:800;font-size:16px" id="rightSessions">0</div>
          </div>
        </div>
      </div>

      <div style="margin-top:14px"><div class="graph-wrap" style="padding:12px"><canvas id="miniChart" width="400" height="120"></canvas></div></div>

      <h4 style="margin-top:16px">Recent Sessions</h4>
      <div class="history" id="recentSessions"></div>

      <div style="margin-top:12px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
        <button class="btn btn-start" id="exportBtn" style="flex:1;min-width:120px;"><i class="fa-solid fa-download"></i> Export</button>
        <button class="btn btn-pause" id="clearBtn" style="flex:1;min-width:120px;"><i class="fa-solid fa-trash"></i> Clear</button>
      </div>

    </div>
  </div>
</div>

<script>
/* =========================
   Smart Pomodoro Widget
   - Mobile-first optimized
   - localStorage based
   - floating draggable clock
   - background timer continues when modal closed
   - weekly reset, monthly tracking
   - canvas graph (week/month)
   - toast notification system
   ========================= */

(function(){
  // ---------- Config ----------
  const DEFAULT_MIN = 25;
  const STORAGE_KEY = "es_timer_v1";
  const WEEK_KEY = "es_timer_week_start_v1";

  // ---------- DOM ----------
  const overlay = document.getElementById("overlay");
  const floating = document.getElementById("floatingClock");
  const miniTime = document.getElementById("miniTime");
  const timerDisplay = document.getElementById("timerDisplay");
  const startBtn = document.getElementById("startBtn");
  const pauseBtn = document.getElementById("pauseBtn");
  const resetBtn = document.getElementById("resetBtn");
  const presetEls = document.querySelectorAll(".preset-item");
  const statSessions = document.getElementById("statSessions");
  const statThisWeek = document.getElementById("statThisWeek");
  const statGoalPerc = document.getElementById("statGoalPerc");
  const progressFill = document.getElementById("progressFill");
  const progressLabel = document.getElementById("progressLabel");
  const dailyGoalInput = document.getElementById("dailyGoal");
  const notifyToggle = document.getElementById("notifyToggle");

  const viewTimerBtn = document.getElementById("viewTimerBtn");
  const viewGraphBtn = document.getElementById("viewGraphBtn");
  const timerBlock = document.getElementById("timerBlock");
  const graphBlock = document.getElementById("graphBlock");
  const graphRangeLabel = document.getElementById("graphRange");
  const weekRange = document.getElementById("weekRange");
  const monthRange = document.getElementById("monthRange");
  const focusCanvas = document.getElementById("focusChart");
  const miniCanvas = document.getElementById("miniChart");
  const historyList = document.getElementById("historyList");
  const recentSessions = document.getElementById("recentSessions");
  const rightWeekTotal = document.getElementById("rightWeekTotal");
  const rightMonthTotal = document.getElementById("rightMonthTotal");
  const rightSessions = document.getElementById("rightSessions");
  const exportBtn = document.getElementById("exportBtn");
  const clearBtn = document.getElementById("clearBtn");
  const overlayModal = document.querySelector(".ts-modal");
  const closeModalBtn = document.getElementById("closeModalBtn"); // Mobile UI improvement: close button
  const toastContainer = document.getElementById("toastContainer"); // Mobile UI improvement: toast container

  // ---------- state ----------
  let state = {
    // runtime
    secondsLeft: DEFAULT_MIN * 60,
    running: false,
    endTime: null,
    // data
    sessions: [], // {duration:min, timestamp:ms}
    dailyProgress: {}, // 'YYYY-MM-DD' : minutes
    weeklyTotals: {}, // weekStart(ms): totalMin
    monthlyTotals: {}, // 'YYYY-MM' : totalMin
    totalSessions: 0,
    // settings
    dailyGoal: parseInt(dailyGoalInput.value || 60, 10),
    notify: false,
  };

  // ---------- helpers ----------
  function save(){
    try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
    catch(e){ console.warn("Storage failed",e); }
  }
  function load(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(raw){ Object.assign(state, JSON.parse(raw)); }
    }catch(e){ console.warn("Storage read failed", e); }
    // migrate or ensure keys:
    if(!state.sessions) state.sessions = [];
    if(!state.dailyProgress) state.dailyProgress = {};
    if(!state.weeklyTotals) state.weeklyTotals = {};
    if(!state.monthlyTotals) state.monthlyTotals = {};
    state.dailyGoal = parseInt(state.dailyGoal || dailyGoalInput.value || 60, 10);
    state.notify = !!state.notify;
  }
  function formatTime(sec){
    const m = Math.floor(sec/60).toString().padStart(2,'0');
    const s = Math.floor(sec%60).toString().padStart(2,'0');
    return `${m}:${s}`;
  }
  function getTodayKey(){ const d=new Date(); return d.toISOString().slice(0,10); }
  function getWeekStart(ts){
    const d = ts? new Date(ts) : new Date();
    // compute Monday as week start for consistent rotate (or use user's preference)
    const day = d.getDay(); // 0 Sun .. 6 Sat
    const diff = (day + 6) % 7; // days since Monday
    d.setDate(d.getDate() - diff);
    d.setHours(0,0,0,0);
    return d.getTime();
  }
  function getMonthKey(ts){
    const d = ts? new Date(ts) : new Date();
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
  }

  // Mobile UI improvement: toast notification system
  function showToast(message, type = 'success', duration = 3000){
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    
    const icon = type === 'success' ? 'fa-check-circle' : 
                 type === 'warning' ? 'fa-exclamation-circle' : 'fa-info-circle';
    
    toast.innerHTML = `<i class="fa-solid ${icon}"></i><span>${message}</span>`;
    toastContainer.appendChild(toast);
    
    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateY(-20px)';
      setTimeout(() => toast.remove(), 300);
    }, duration);
  }

  // ---------- persistence with weekly rotation ----------
  function ensureWeeklyRotation(){
    const storedWeek = localStorage.getItem(WEEK_KEY);
    const currentWeek = getWeekStart();
    if(!storedWeek){
      localStorage.setItem(WEEK_KEY, String(currentWeek));
      return;
    }
    const weekNum = parseInt(storedWeek,10);
    if(weekNum !== currentWeek){
      // rotate: remove data older than 8 weeks (keep history in sessions though), but keep monthly
      localStorage.setItem(WEEK_KEY, String(currentWeek));
      // Optionally remove weeklyTotals older than this week to keep small
      Object.keys(state.weeklyTotals).forEach(k=>{
        if(parseInt(k,10) < currentWeek - (1000*60*60*24*7*8)) delete state.weeklyTotals[k];
      });
      save();
    }
  }

  // ---------- UI update ----------
  function refreshUI(){
    // timer display
    timerDisplay.textContent = formatTime(state.secondsLeft);
    miniTime.textContent = formatTime(state.secondsLeft);

    // stats compute
    const todayKey = getTodayKey();
    const todayMin = (state.dailyProgress[todayKey] || 0);
    const weekStart = getWeekStart();
    const weekTotal = Object.keys(state.dailyProgress).reduce((acc,k)=>{
      const d = new Date(k);
      if(getWeekStart(d.getTime()) === weekStart) return acc + (state.dailyProgress[k]||0);
      return acc;
    },0);

    const monthKey = getMonthKey();
    const monthTotal = Object.keys(state.dailyProgress).reduce((acc,k)=>{
      const mk = k.slice(0,7);
      if(mk === monthKey) return acc + (state.dailyProgress[k]||0);
      return acc;
    },0);

    statSessions.textContent = state.totalSessions || 0;
    statThisWeek.textContent = `${Math.round(weekTotal/60)}h`;
    rightWeekTotal.textContent = `${weekTotal} min`;
    rightMonthTotal.textContent = `${monthTotal} min`;
    rightSessions.textContent = `${state.totalSessions||0}`;

    // progress
    const goal = parseInt(state.dailyGoal,10) || 60;
    const pct = Math.min(100, Math.round((todayMin/goal) * 100));
    progressFill.style.width = pct + "%";
    progressLabel.textContent = `${todayMin}/${goal} min`;
    statGoalPerc.textContent = `${pct}%`;

    // history lists
    renderHistory();
    drawMiniChart();
    drawFocusChart(currGraphRange);
  }

  function renderHistory(){
    // recent sessions (last 20)
    const rec = state.sessions.slice().reverse().slice(0,20);
    recentSessions.innerHTML = rec.map(s=>{
      const dt = new Date(s.timestamp);
      const t = dt.toLocaleString();
      return `<div class="session-item"><div class="left">${s.duration} min • ${s.note || 'focus'}</div><div class="right">${t}</div></div>`;
    }).join('') || '<div style="color:var(--muted);padding:12px;border-radius:8px">No sessions yet — start a focus session to track progress.</div>';

    // history small (for graph detail)
    historyList.innerHTML = state.sessions.slice().reverse().slice(0,40).map(s=>{
      const dt=new Date(s.timestamp);
      return `<div class="session-item"><div class="left">${s.duration} min</div><div class="right">${dt.toLocaleDateString()} ${dt.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</div></div>`;
    }).join('');
  }

  // ---------- timer runtime ----------
  let tickInterval = null;
  function startTimer(minutes){
    if(typeof minutes === 'number' && minutes > 0) state.secondsLeft = minutes*60;
    if(state.running) return;
    state.running = true;
    state.endTime = Date.now() + state.secondsLeft*1000;
    save();

    // Mobile UI improvement: show toast notification
    showToast('Timer started!', 'success', 2000);

    // set up tick
    tickInterval = setInterval(()=> tick(), 250);
    refreshUI();
  }
  function pauseTimer(){
    if(!state.running) return;
    state.running = false;
    // recalc secondsLeft
    if(state.endTime) state.secondsLeft = Math.max(0, Math.round((state.endTime - Date.now())/1000));
    state.endTime = null;
    clearInterval(tickInterval);
    tickInterval = null;
    save();
    
    // Mobile UI improvement: show toast notification
    showToast('Timer paused', 'warning', 2000);
    
    refreshUI();
  }
  function resetTimer(){
    pauseTimer();
    state.secondsLeft = DEFAULT_MIN*60;
    state.endTime = null;
    save();
    
    // Mobile UI improvement: show toast notification
    showToast('Timer reset', 'warning', 2000);
    
    refreshUI();
  }

  function tick(){
    if(!state.running) return;
    const remainMs = state.endTime - Date.now();
    if(remainMs <= 0){
      // session complete
      state.secondsLeft = 0;
      completeSession();
    } else {
      state.secondsLeft = Math.ceil(remainMs/1000);
      // update UI frequently
      refreshUI();
    }
  }

  // when session finishes
  function completeSession(){
    // mark session length in minutes (round)
    const durationMin = Math.max(1, Math.round(( (DEFAULT_MIN*60) - state.secondsLeft ) / 60 ) || DEFAULT_MIN);
    const ts = Date.now();
    state.sessions.push({duration: durationMin, timestamp: ts, note: 'session'});
    state.totalSessions = (state.totalSessions||0) + 1;

    // update daily progress
    const today = getTodayKey();
    state.dailyProgress[today] = (state.dailyProgress[today] || 0) + durationMin;

    // update weekly & monthly
    const weekKey = String(getWeekStart());
    state.weeklyTotals[weekKey] = (state.weeklyTotals[weekKey]||0) + durationMin;
    const monthKey = getMonthKey(ts);
    state.monthlyTotals[monthKey] = (state.monthlyTotals[monthKey]||0) + durationMin;

    // stop timer and notify
    state.running = false;
    state.endTime = null;
    state.secondsLeft = DEFAULT_MIN*60;
    save();

    // popup like notification (browser notification if allowed), small confetti substitute via modal pulse
    showSessionComplete();
    refreshUI();
  }

  function showSessionComplete(){
    // small visual: scale floating clock briefly
    floating.style.transform = "scale(1.06)";
    setTimeout(()=> floating.style.transform = "", 350);

    // Mobile UI improvement: show toast notification
    showToast('🎉 Session completed! Great work!', 'success', 4000);

    if(state.notify && "Notification" in window){
      if(Notification.permission === "granted"){
        new Notification("Pomodoro Completed", {body:"Great work — session recorded to local stats."});
      } else if(Notification.permission !== "denied"){
        Notification.requestPermission().then(p=>{
          if(p === "granted") new Notification("Pomodoro Completed",{body:"Nice! Notifications enabled."});
        });
      }
    }
    // also show ephemeral badge inside modal if open
    const oldText = startBtn.innerHTML;
    startBtn.innerHTML = '<i class="fa-solid fa-check"></i> Complete';
    setTimeout(()=> startBtn.innerHTML = oldText, 1400);
  }

  // ---------- UI events ----------
  startBtn.addEventListener("click",()=>{
    if(!state.running){
      // if secondsLeft is zero, reset to default
      if(state.secondsLeft <= 0) state.secondsLeft = DEFAULT_MIN*60;
      startTimer(Math.round(state.secondsLeft/60));
    }
  });
  pauseBtn.addEventListener("click", ()=> pauseTimer());
  resetBtn.addEventListener("click", ()=> { resetTimer(); });

  // presets
  presetEls.forEach(p=>{
    p.addEventListener("click", ()=> {
      const m = parseInt(p.dataset.min,10) || DEFAULT_MIN;
      state.secondsLeft = m*60;
      pauseTimer();
      // Mobile UI improvement: show toast notification
      showToast(`Timer set to ${m} minutes`, 'success', 2000);
      refreshUI();
    });
  });

  // floating open modal
//   floating.addEventListener("click", (e)=>{
//     // open overlay
//     overlay.classList.add("show");
//     overlay.setAttribute("aria-hidden","false");
//     overlayModal.focus?.();
//   });
// ---------- floating open modal (desktop + mobile touch fix) ----------
let isModalOpen = false; // debounce flag

function openModal() {
  if (isModalOpen) return; // prevent multiple triggers
  isModalOpen = true;
  overlay.classList.add("show");
  overlay.setAttribute("aria-hidden", "false");
  overlayModal.focus?.();
  // reset flag after tiny delay
  setTimeout(() => { isModalOpen = false; }, 100);
}

// Add both click and touchstart for mobile
floating.addEventListener("click", openModal);
floating.addEventListener("touchstart", (e) => {
  e.preventDefault(); // prevent ghost click on mobile
  openModal();
});


  // Mobile UI improvement: close button handler
  closeModalBtn.addEventListener("click", ()=>{
    overlay.classList.remove("show");
    overlay.setAttribute("aria-hidden","true");
  });

  // close overlay on background click (but do not stop timer)
  overlay.addEventListener("click", (e)=>{
    if(e.target === overlay){
      overlay.classList.remove("show");
      overlay.setAttribute("aria-hidden","true");
    }
  });

  // drag floating
  (function draggable(el){
    let isDown=false, offset={x:0,y:0}, start={x:0,y:0};
    el.addEventListener("mousedown", startDrag);
    el.addEventListener("touchstart", startDrag,{passive:false});
    function startDrag(e){
      e.preventDefault();
      isDown = true;
      const rect = el.getBoundingClientRect();
      start.x = (e.touches ? e.touches[0].clientX : e.clientX);
      start.y = (e.touches ? e.touches[0].clientY : e.clientY);
      offset.x = start.x - rect.left;
      offset.y = start.y - rect.top;
      document.addEventListener("mousemove", onMove);
      document.addEventListener("touchmove", onMove,{passive:false});
      document.addEventListener("mouseup", endDrag);
      document.addEventListener("touchend", endDrag);
    }
    function onMove(e){
      if(!isDown) return;
      const clientX = (e.touches ? e.touches[0].clientX : e.clientX);
      const clientY = (e.touches ? e.touches[0].clientY : e.clientY);
      let left = clientX - offset.x;
      let top = clientY - offset.y;
      // clamp inside viewport
      left = Math.max(8, Math.min(window.innerWidth - el.offsetWidth - 8, left));
      top = Math.max(8, Math.min(window.innerHeight - el.offsetHeight - 8, top));
      el.style.right = "auto";
      el.style.left = left + "px";
      el.style.top = top + "px";
      el.style.bottom = "auto";
    }
    function endDrag(){
      isDown = false;
      document.removeEventListener("mousemove", onMove);
      document.removeEventListener("touchmove", onMove);
      document.removeEventListener("mouseup", endDrag);
      document.removeEventListener("touchend", endDrag);
    }
  })(floating);

  // view toggle (timer/graph)
  viewTimerBtn.addEventListener("click", ()=>{
    timerBlock.style.display = "";
    graphBlock.style.display = "none";
    viewTimerBtn.classList.add("active");
    viewGraphBtn.classList.remove("active");
  });
  viewGraphBtn.addEventListener("click", ()=>{
    timerBlock.style.display = "none";
    graphBlock.style.display = "";
    viewGraphBtn.classList.add("active");
    viewTimerBtn.classList.remove("active");
  });

  // graph range toggle
  let currGraphRange = "week";
  weekRange.addEventListener("click", ()=> { 
    currGraphRange="week"; 
    drawFocusChart("week"); 
    graphRangeLabel.textContent="Week"; 
    weekRange.classList.add("active"); 
    monthRange.classList.remove("active");
  });
  monthRange.addEventListener("click", ()=> { 
    currGraphRange="month"; 
    drawFocusChart("month"); 
    graphRangeLabel.textContent="Month"; 
    monthRange.classList.add("active"); 
    weekRange.classList.remove("active");
  });
  // init chips
  weekRange.classList.add("active");
  viewTimerBtn.classList.add("active");

  // notification toggle
  notifyToggle.addEventListener("change", (e)=>{ 
    state.notify = e.target.checked; 
    save(); 
    // Mobile UI improvement: show toast notification
    if(e.target.checked){
      showToast('Notifications enabled', 'success', 2000);
      // Request permission if not granted
      if("Notification" in window && Notification.permission === "default"){
        Notification.requestPermission();
      }
    } else {
      showToast('Notifications disabled', 'warning', 2000);
    }
  });

  // export / clear
  exportBtn.addEventListener("click", ()=>{
    const blob = new Blob([JSON.stringify(state, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'eduspark_timer_export.json'; document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
    // Mobile UI improvement: show toast notification
    showToast('Data exported successfully', 'success', 3000);
  });
  clearBtn.addEventListener("click", ()=>{
    if(!confirm("Clear all local timer data? This removes sessions stored in this browser.")) return;
    state.sessions = []; 
    state.dailyProgress={}; 
    state.weeklyTotals={}; 
    state.monthlyTotals={}; 
    state.totalSessions = 0;
    save(); 
    refreshUI();
    // Mobile UI improvement: show toast notification
    showToast('All data cleared', 'warning', 3000);
  });

  // daily goal change
  dailyGoalInput.addEventListener("change", ()=>{ 
    state.dailyGoal = parseInt(dailyGoalInput.value||60,10); 
    save(); 
    refreshUI(); 
    // Mobile UI improvement: show toast notification
    showToast(`Daily goal set to ${state.dailyGoal} minutes`, 'success', 2000);
  });

  // ---------- charts (canvas drawing) ----------
  function drawMiniChart(){
    const ctx = miniCanvas.getContext('2d');
    miniCanvas.width = miniCanvas.clientWidth * devicePixelRatio;
    miniCanvas.height = miniCanvas.clientHeight * devicePixelRatio;
    ctx.scale(devicePixelRatio, devicePixelRatio);

    // prepare last 7 days data
    const labels = [];
    const data = [];
    for(let i=6;i>=0;i--){
      const d = new Date(); d.setDate(d.getDate() - i);
      const key = d.toISOString().slice(0,10);
      labels.push(d.toLocaleDateString([], {weekday:'short'}));
      data.push(state.dailyProgress[key] || 0);
    }
    // draw
    const w = miniCanvas.clientWidth;
    const h = miniCanvas.clientHeight;
    ctx.clearRect(0,0,w*devicePixelRatio,h*devicePixelRatio);
    // background
    ctx.fillStyle = "rgba(255,255,255,0.02)";
    roundRect(ctx, 0,0, w, h, 8); ctx.fill();

    // bars
    const max = Math.max(1, ...data);
    const barW = (w - 20) / data.length;
    data.forEach((v,i)=>{
      const x = 10 + i*barW;
      const barH = (v/max) * (h - 36);
      const y = h - 22 - barH;
      // gradient
      const g = ctx.createLinearGradient(x,y,x, y+barH);
      g.addColorStop(0, 'rgba(124,77,255,0.95)');
      g.addColorStop(1, 'rgba(255,107,107,0.9)');
      ctx.fillStyle = g;
      roundRect(ctx, x, y, barW*0.6, barH, 6); ctx.fill();
      // label
      ctx.fillStyle = 'rgba(255,255,255,0.8)';
      ctx.font = '10px Inter';
      ctx.fillText(labels[i], x, h - 6);
    });
  }

  function drawFocusChart(range){
    const ctx = focusCanvas.getContext('2d');
    focusCanvas.width = focusCanvas.clientWidth * devicePixelRatio;
    focusCanvas.height = focusCanvas.clientHeight * devicePixelRatio;
    ctx.scale(devicePixelRatio, devicePixelRatio);
    const w = focusCanvas.clientWidth; const h = focusCanvas.clientHeight;

    ctx.clearRect(0,0,w*devicePixelRatio,h*devicePixelRatio);
    ctx.fillStyle = "rgba(255,255,255,0.01)"; roundRect(ctx,0,0,w,h,10); ctx.fill();

    if(range === "week"){
      // last 7 days
      const labels = []; const data = [];
      for(let i=6;i>=0;i--){
        const d = new Date(); d.setDate(d.getDate() - i);
        const k = d.toISOString().slice(0,10);
        labels.push(d.toLocaleDateString([], {weekday:'short'}));
        data.push(state.dailyProgress[k] || 0);
      }
      drawLineBars(ctx, w, h, labels, data);
    } else {
      // last 6 months
      const labels = []; const data = [];
      const now = new Date();
      for(let i=5;i>=0;i--){
        const d = new Date(now.getFullYear(), now.getMonth()-i, 1);
        const k = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
        labels.push(d.toLocaleString([], {month:'short'}));
        data.push(state.monthlyTotals[k] || 0);
      }
      drawLineBars(ctx, w, h, labels, data, true);
    }
  }

  function drawLineBars(ctx,w,h,labels,data,isMonth=false){
    // compute max
    const padding = 28;
    const max = Math.max(1, ...data);
    const step = (w - padding*2) / (data.length - 1 || 1);
    // grid lines
    ctx.strokeStyle = "rgba(255,255,255,0.03)"; ctx.lineWidth = 1;
    for(let i=0;i<4;i++){
      const y = padding + i*( (h - padding*2)/3 );
      ctx.beginPath(); ctx.moveTo(padding, y); ctx.lineTo(w - padding, y); ctx.stroke();
    }
    // line
    ctx.beginPath();
    data.forEach((v,i)=>{
      const x = padding + i*step;
      const y = h - padding - (v/max) * (h - padding*2);
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    // stroke gradient
    const g = ctx.createLinearGradient(0,0,w,0);
    g.addColorStop(0, 'rgba(124,77,255,0.95)'); g.addColorStop(1, 'rgba(255,107,107,0.95)');
    ctx.strokeStyle = g; ctx.lineWidth = 3; ctx.stroke();

    // fill area
    ctx.lineTo(w - padding, h-padding); ctx.lineTo(padding, h-padding); ctx.closePath();
    const gf = ctx.createLinearGradient(0,0,0,h);
    gf.addColorStop(0, 'rgba(124,77,255,0.12)'); gf.addColorStop(1, 'rgba(255,107,107,0.03)');
    ctx.fillStyle = gf; ctx.fill();

    // labels
    ctx.fillStyle = 'rgba(230,240,255,0.95)'; ctx.font = '12px Inter';
    data.forEach((v,i)=>{
      const x = padding + i*step; const y = h - padding - (v/max) * (h - padding*2);
      ctx.fillText(labels[i], x - 12, h - 8);
      ctx.fillStyle = 'rgba(230,240,255,0.9)'; ctx.fillText(String(v)+'m', x - 14, y - 6);
      ctx.fillStyle = 'rgba(230,240,255,0.95)';
    });
  }

  // helper roundRect
  function roundRect(ctx,x,y,w,h,r){
    const min = Math.min(w,h);
    if(typeof r === 'undefined') r = 6;
    if(r > (min/2)) r = min/2;
    ctx.beginPath();
    ctx.moveTo(x+r,y);
    ctx.arcTo(x+w,y,x+w,y+h,r);
    ctx.arcTo(x+w,y+h,x,y+h,r);
    ctx.arcTo(x,y+h,x,y,r);
    ctx.arcTo(x,y,x+w,y,r);
    ctx.closePath();
  }

  // ---------- storage helpers for adding minutes mid-session (e.g., pausing/resuming) ----------
  function addMinutesToToday(min){
    const key = getTodayKey();
    state.dailyProgress[key] = (state.dailyProgress[key] || 0) + min;
    const wk = String(getWeekStart());
    state.weeklyTotals[wk] = (state.weeklyTotals[wk] || 0) + min;
    const mk = getMonthKey();
    state.monthlyTotals[mk] = (state.monthlyTotals[mk] || 0) + min;
    save();
  }

  // ---------- simulate mid-session saving when paused manually (optional) ----------
  // For simplicity, we only create a session when timer reaches 0. But we might also allow "finish early" to record partial sessions:
  // We'll add a right-click on reset to store current partial time as session:
  resetBtn.addEventListener("contextmenu", (e)=>{
    e.preventDefault();
    // record partial if > 1 minute
    const elapsedMin = Math.round((DEFAULT_MIN*60 - state.secondsLeft)/60);
    if(elapsedMin > 0){
      state.sessions.push({duration: elapsedMin, timestamp: Date.now(), note:"partial"});
      state.totalSessions = (state.totalSessions||0) + 1;
      addMinutesToToday(elapsedMin);
      save(); refreshUI();
      // Mobile UI improvement: show toast notification
      showToast(`Partial session saved (${elapsedMin} min)`, 'success', 3000);
    }
  });

  // ---------- load/save init ----------
  load(); ensureWeeklyRotation(); refreshUI();

  // restore timer if it was running before reload
  if(state.running && state.endTime){
    const remain = Math.round((state.endTime - Date.now())/1000);
    if(remain <= 0){
      state.running = false; state.secondsLeft = DEFAULT_MIN*60; state.endTime = null;
      save();
    } else {
      state.secondsLeft = remain;
      tickInterval = setInterval(()=> tick(), 250);
    }
  }

  // ---------- draw initial charts ----------
  drawMiniChart(); drawFocusChart(currGraphRange="week");

  // re-render when window focus changes to keep times accurate
  window.addEventListener("focus", ()=> { 
    if(state.running && state.endTime){ 
      state.secondsLeft = Math.max(0, Math.round((state.endTime - Date.now())/1000)); 
    } 
    refreshUI(); 
  });

  // Resize handling for canvas
  let resizeTimeout=null;
  window.addEventListener("resize", ()=>{ 
    clearTimeout(resizeTimeout); 
    resizeTimeout = setTimeout(()=>{ 
      drawMiniChart(); 
      drawFocusChart(currGraphRange); 
    }, 240); 
  });

  // ---------- auto save every 10s while running ----------
  setInterval(()=>{ if(state.running) save(); }, 10000);

  // Mobile UI improvement: show chip text on wider screens
  const updateChipText = () => {
    const chipTexts = document.querySelectorAll('.chip-text');
    chipTexts.forEach(text => {
      text.style.display = window.innerWidth >= 480 ? 'inline' : 'none';
    });
  };
  updateChipText();
  window.addEventListener("resize", updateChipText);

  // Mobile UI improvement: prevent scroll when modal is open
  const originalOverflow = document.body.style.overflow;
  overlay.addEventListener('transitionend', () => {
    if(overlay.classList.contains('show')){
      document.body.style.overflow = 'hidden';
    } else {
      document.body.style.overflow = originalOverflow;
    }
  });

  // Mobile UI improvement: haptic feedback for mobile devices (if supported)
  function triggerHaptic(intensity = 'light') {
    if (navigator.vibrate) {
      const patterns = {
        light: 10,
        medium: 20,
        heavy: 50
      };
      navigator.vibrate(patterns[intensity] || 10);
    }
  }

  // Mobile UI improvement: add haptic feedback to buttons
  [startBtn, pauseBtn, resetBtn, ...presetEls].forEach(btn => {
    btn.addEventListener('click', () => triggerHaptic('light'));
  });

  // Mobile UI improvement: swipe to close modal
  let touchStartY = 0;
  let touchEndY = 0;
  
  overlayModal.addEventListener('touchstart', (e) => {
    touchStartY = e.changedTouches[0].screenY;
  }, {passive: true});

  overlayModal.addEventListener('touchend', (e) => {
    touchEndY = e.changedTouches[0].screenY;
    handleSwipe();
  }, {passive: true});

  function handleSwipe() {
    const swipeDistance = touchEndY - touchStartY;
    // Swipe down to close (minimum 100px)
    if (swipeDistance > 100) {
      overlay.classList.remove("show");
      overlay.setAttribute("aria-hidden","true");
      triggerHaptic('medium');
    }
  }

  // Mobile UI improvement: keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    // Only trigger if modal is open and not typing in input
    if (!overlay.classList.contains('show') || e.target.tagName === 'INPUT') return;
    
    switch(e.key) {
      case ' ': // Space to start/pause
      case 'Enter':
        e.preventDefault();
        if(state.running) pauseTimer(); else startTimer();
        break;
      case 'r': // R to reset
      case 'R':
        e.preventDefault();
        resetTimer();
        break;
      case 'Escape': // Escape to close
        overlay.classList.remove("show");
        overlay.setAttribute("aria-hidden","true");
        break;
    }
  });

  // Mobile UI improvement: add loading state to export/clear buttons
  exportBtn.addEventListener('click', () => {
    exportBtn.disabled = true;
    exportBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Exporting...';
    setTimeout(() => {
      exportBtn.disabled = false;
      exportBtn.innerHTML = '<i class="fa-solid fa-download"></i> Export';
    }, 1000);
  });

  // Mobile UI improvement: PWA install prompt handling
  let deferredPrompt;
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    // Show install toast after 5 seconds
    setTimeout(() => {
      showToast('💡 Add to Home Screen for quick access!', 'success', 5000);
    }, 5000);
  });

  // Mobile UI improvement: service worker registration for offline support
  if ('serviceWorker' in navigator) {
    // Note: This would require a separate service worker file in production
    console.log('Service Worker support detected - ready for PWA setup');
  }

  // Mobile UI improvement: battery status monitoring (pause timer on low battery)
  if ('getBattery' in navigator) {
    navigator.getBattery().then((battery) => {
      battery.addEventListener('levelchange', () => {
        if (battery.level < 0.1 && state.running) {
          pauseTimer();
          showToast('⚠️ Timer paused - Low battery detected', 'warning', 4000);
        }
      });
    });
  }

  // Mobile UI improvement: wake lock API to keep screen on during timer
  let wakeLock = null;
  async function requestWakeLock() {
    if ('wakeLock' in navigator && state.running) {
      try {
        wakeLock = await navigator.wakeLock.request('screen');
        wakeLock.addEventListener('release', () => {
          console.log('Wake Lock released');
        });
      } catch (err) {
        console.log('Wake Lock error:', err);
      }
    }
  }

  function releaseWakeLock() {
    if (wakeLock !== null) {
      wakeLock.release();
      wakeLock = null;
    }
  }

  // Mobile UI improvement: request wake lock when timer starts
  const originalStartTimer = startTimer;
  startTimer = function(...args) {
    originalStartTimer.apply(this, args);
    requestWakeLock();
  };

  // Mobile UI improvement: release wake lock when timer stops
  const originalPauseTimer = pauseTimer;
  pauseTimer = function(...args) {
    originalPauseTimer.apply(this, args);
    releaseWakeLock();
  };

  // Mobile UI improvement: visibility change handling
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
      // Page is hidden - save state
      save();
    } else {
      // Page is visible - refresh UI and check timer
      if(state.running && state.endTime){ 
        state.secondsLeft = Math.max(0, Math.round((state.endTime - Date.now())/1000));
        if(state.secondsLeft <= 0) {
          completeSession();
        }
      }
      refreshUI();
    }
  });

  // Mobile UI improvement: connection status monitoring
  window.addEventListener('online', () => {
    showToast('✅ Back online', 'success', 2000);
  });

  window.addEventListener('offline', () => {
    showToast('📡 Offline mode - Data saved locally', 'warning', 3000);
  });

  // Mobile UI improvement: smart notification timing
  function scheduleSmartNotification() {
    if (!state.running || !state.notify) return;
    
    const halfTime = Math.floor(state.secondsLeft / 2);
    setTimeout(() => {
      if (state.running) {
        showToast('⏰ Halfway through your session!', 'success', 2000);
        triggerHaptic('medium');
      }
    }, halfTime * 1000);

    // 1 minute warning
    const oneMinuteWarning = state.secondsLeft - 60;
    if (oneMinuteWarning > 0) {
      setTimeout(() => {
        if (state.running) {
          showToast('⏱️ 1 minute remaining', 'warning', 2000);
          triggerHaptic('light');
        }
      }, oneMinuteWarning * 1000);
    }
  }

  // Mobile UI improvement: call smart notifications when timer starts
  const originalStartTimerWithNotif = startTimer;
  startTimer = function(...args) {
    originalStartTimerWithNotif.apply(this, args);
    scheduleSmartNotification();
  };

  // expose tiny API on window to allow external controls if you want
  window.ES_Timer = {
    open: ()=> { 
      overlay.classList.add('show'); 
      overlay.setAttribute("aria-hidden","false");
    },
    close: ()=> { 
      overlay.classList.remove('show'); 
      overlay.setAttribute("aria-hidden","true");
    },
    start: ()=> startTimer(),
    pause: ()=> pauseTimer(),
    reset: ()=> resetTimer(),
    export: ()=> exportBtn.click(),
    getState: ()=> JSON.parse(JSON.stringify(state)),
    // Mobile UI improvement: additional API methods
    setGoal: (minutes) => {
      state.dailyGoal = parseInt(minutes, 10);
      dailyGoalInput.value = state.dailyGoal;
      save();
      refreshUI();
      showToast(`Daily goal updated to ${minutes} minutes`, 'success', 2000);
    },
    addSession: (minutes, note = 'manual') => {
      const ts = Date.now();
      state.sessions.push({duration: minutes, timestamp: ts, note: note});
      state.totalSessions = (state.totalSessions || 0) + 1;
      addMinutesToToday(minutes);
      save();
      refreshUI();
      showToast(`Manual session added: ${minutes} min`, 'success', 2000);
    },
    getStats: () => ({
      totalSessions: state.totalSessions,
      todayMinutes: state.dailyProgress[getTodayKey()] || 0,
      weekTotal: Object.keys(state.dailyProgress).reduce((acc, k) => {
        const d = new Date(k);
        if (getWeekStart(d.getTime()) === getWeekStart()) return acc + (state.dailyProgress[k] || 0);
        return acc;
      }, 0),
      monthTotal: Object.keys(state.dailyProgress).reduce((acc, k) => {
        if (k.slice(0, 7) === getMonthKey()) return acc + (state.dailyProgress[k] || 0);
        return acc;
      }, 0),
      goalProgress: Math.round(((state.dailyProgress[getTodayKey()] || 0) / state.dailyGoal) * 100)
    })
  };

  // Mobile UI improvement: double-tap floating button for quick start
  let lastTap = 0;
  floating.addEventListener('touchend', (e) => {
    const currentTime = new Date().getTime();
    const tapLength = currentTime - lastTap;
    if (tapLength < 300 && tapLength > 0) {
      e.preventDefault();
      // Double tap detected - quick start/pause
      if (state.running) {
        pauseTimer();
      } else {
        if (state.secondsLeft <= 0) state.secondsLeft = DEFAULT_MIN * 60;
        startTimer();
      }
      triggerHaptic('medium');
    }
    lastTap = currentTime;
  });

  // Mobile UI improvement: long press floating button for reset
  let pressTimer;
  floating.addEventListener('touchstart', (e) => {
    pressTimer = setTimeout(() => {
      if (!overlay.classList.contains('show')) {
        resetTimer();
        triggerHaptic('heavy');
      }
    }, 800);
  });

  floating.addEventListener('touchend', () => {
    clearTimeout(pressTimer);
  });

  floating.addEventListener('touchmove', () => {
    clearTimeout(pressTimer);
  });

  // Mobile UI improvement: initialize notification toggle state
  notifyToggle.checked = state.notify;

  // Mobile UI improvement: add visual indicator when timer is running
  function updateFloatingClockStyle() {
    if (state.running) {
      floating.style.animation = 'pulse 1.5s ease-in-out infinite';
      floating.style.boxShadow = '0 10px 40px rgba(124,77,255,0.35)';
    } else {
      floating.style.animation = '';
      floating.style.boxShadow = '0 10px 30px rgba(124,77,255,0.18)';
    }
  }

  // Add pulse animation
  const style = document.createElement('style');
  style.textContent = `
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
  `;
  document.head.appendChild(style);

  // Update clock style on state change
  setInterval(() => {
    updateFloatingClockStyle();
  }, 1000);

  // Mobile UI improvement: show welcome toast on first load
  const hasVisited = localStorage.getItem('es_timer_visited');
  if (!hasVisited) {
    setTimeout(() => {
      showToast('👋 Welcome! Tap the floating button to start', 'success', 5000);
      localStorage.setItem('es_timer_visited', 'true');
    }, 1000);
  }

  console.log('🎉 EduSpark Pomodoro Timer initialized - Mobile optimized!');
  console.log('💡 Use ES_Timer API for programmatic control');
  console.log('📱 Features: Touch gestures, haptic feedback, wake lock, offline support');

})();
</script>

</body>
</html>